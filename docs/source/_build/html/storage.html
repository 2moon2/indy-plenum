

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Storage components &mdash; Indy Plenum  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Request handling" href="request_handling.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Indy Plenum
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="main.html">Overview of the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="catchup.html">Ledger catchup</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_handling.html">Request handling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Storage components</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ledger">1. Ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="#state">2. State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#seq-no-database">3. Seq No database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-storage-abstractions">Common Storage abstractions</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Indy Plenum</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Storage components</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/storage.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="storage-components">
<span id="storage-components"></span><h1>Storage components<a class="headerlink" href="#storage-components" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ledger">
<span id="ledger"></span><h2>1. Ledger<a class="headerlink" href="#ledger" title="Permalink to this headline">¶</a></h2>
<p>The ledger is an ordered log of transactions with each transaction assigned a unique monotonically increasing positive integer called sequence number.
Sequence numbers start from 1 and then increase by 1 for each new transaction. There are no gaps in sequence numbers.
The actual storage behind the ledger can be flat files with each transaction in a new line or a key value store like LevelDB with key being the sequence number and value being the transaction.
A transaction is serialised (currently as MsgPack) before storing in the ledger, more on this in the Serialisation doc.
Each node hosts several ledgers each identified by a unique id:</p>
<ul class="simple">
<li>Pool Ledger (id is 0): Contains transactions related to pool membership, like joining of new nodes, suspension of existing nodes, changing the IP/port or keys of existing nodes.</li>
<li>Domain Ledger (id is 1): Contains transactions related to the core application logic. Currently it contains NYM transactions. The <code class="docutils literal notranslate"><span class="pre">indy-node</span></code> codebase extends this ledger with other identity transactions.</li>
<li>Config Ledger (id is 2): Contains transactions related to the configuration parameters for which the pool needs to agree, eg. if each node of the pool needs to use the value <code class="docutils literal notranslate"><span class="pre">5</span></code> for a config variable <code class="docutils literal notranslate"><span class="pre">x</span></code>, then this ledger should contain transaction specifying the value of <code class="docutils literal notranslate"><span class="pre">x</span></code> as <code class="docutils literal notranslate"><span class="pre">5</span></code>. The <code class="docutils literal notranslate"><span class="pre">indy-node</span></code> codebase extends this ledger with source code update transactions.</li>
</ul>
<p>More ledgers can added by plugins. Each correct node should have exactly the same transactions for each ledger id.</p>
<p>A ledger is associated with a <a class="reference external" href="https://github.com/google/certificate-transparency/blob/master/python/ct/crypto/merkle.py">compact merkle tree</a>.
Each new transaction is added to the ledger (log) and is also hashed (sha256) and this hash becomes a new leaf of the merkle tree which also
results in a new merkle root. Thus for each transaction a merkle proof of presence, called <code class="docutils literal notranslate"><span class="pre">inclusion</span> <span class="pre">proof</span></code> or <code class="docutils literal notranslate"><span class="pre">audit_path</span></code> can be created by
using the root hash a few (<code class="docutils literal notranslate"><span class="pre">O(lgn)</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span></code> being the total number of leaves/transactions in the tree/ledger) intermediate hashes.</p>
<p>Hashes of all the leaves and intermediate nodes of the tree are stored in a <code class="docutils literal notranslate"><span class="pre">HashStore</span></code>, enabling the creating of inclusion proofs and subset proofs. A subset proof
proves that a particular merkle tree is a subset of another (usually larger) merkle tree; more on this in the Catchup doc. The <code class="docutils literal notranslate"><span class="pre">HashStore</span></code> has 2 separate storages for storing leaves
and intermediate nodes, each leaf or node of the tree is 32 bytes. Each of these storages can be a binary file or a key value store.
The leaf or node hashes are queried by their number. When a client write request completes or it requests a transaction with a particular sequence number from a ledger,
the transaction is returned with its inclusion proof.</p>
<p>Relevant code:</p>
<ul class="simple">
<li>Ledger: <code class="docutils literal notranslate"><span class="pre">plenum/common/ledger.py</span></code> and <code class="docutils literal notranslate"><span class="pre">ledger/ledger.py</span></code></li>
<li>Compact Merkle Tree: <code class="docutils literal notranslate"><span class="pre">ledger/compact_merkle_tree.py</span></code></li>
<li>HashStore: <code class="docutils literal notranslate"><span class="pre">ledger/hash_stores/hash_store.py</span></code></li>
</ul>
</div>
<div class="section" id="state">
<span id="state"></span><h2>2. State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h2>
<p>The state can be considered a collection of key value pairs but this collection has some properties of merkle tree like a root hash and
inclusion proof of the keys, eg. If there are 3 key value pairs <code class="docutils literal notranslate"><span class="pre">k1-v1</span></code>, <code class="docutils literal notranslate"><span class="pre">k2-&gt;v2</span></code> and <code class="docutils literal notranslate"><span class="pre">k3-&gt;v3</span></code>, then state will have a root hash say <code class="docutils literal notranslate"><span class="pre">R</span></code>
and a proof can be generated that state with root hash <code class="docutils literal notranslate"><span class="pre">R</span></code> has a key <code class="docutils literal notranslate"><span class="pre">k1</span></code> with value <code class="docutils literal notranslate"><span class="pre">v1</span></code>, similarly for other keys. When a new key is added
or value of an old key is changed the root hash changes from <code class="docutils literal notranslate"><span class="pre">R</span></code> to <code class="docutils literal notranslate"><span class="pre">R'</span></code>. Note that the order of insertion of keys does not matter, any order of the
keys will result in the same root hash and same inclusion proof. The underlying data structure of state is the <a class="reference external" href="https://blog.ethereum.org/2015/11/15/merkling-in-ethereum/">Merkle Patricia Trie</a> used by Ethereum.
The state is built from a ledger, hence each ledger will usually have a corresponding state. State can be reconstructed from the Ledger.</p>
<p>Relevant code:</p>
<ul class="simple">
<li>State: <code class="docutils literal notranslate"><span class="pre">state/pruning_state.py</span></code></li>
<li>Merkle Patricia Trie: <code class="docutils literal notranslate"><span class="pre">state/trie/pruning_trie.py</span></code></li>
</ul>
</div>
<div class="section" id="seq-no-database">
<span id="seq-no-database"></span><h2>3. Seq No database<a class="headerlink" href="#seq-no-database" title="Permalink to this headline">¶</a></h2>
<p>Each client request is uniquely identified by a 2-tuple <code class="docutils literal notranslate"><span class="pre">identifier</span></code> and <code class="docutils literal notranslate"><span class="pre">reqId</span></code>. When this request is ordered (consensus successfully completes),
it is stored in the ledger and assigned a sequence number. This database stores the mapping <code class="docutils literal notranslate"><span class="pre">(identifier,</span> <span class="pre">reqId)</span> <span class="pre">-&gt;</span> <span class="pre">seq_no</span></code> in a key value store.One use case is that the client can ask any node to give it the transaction corresponding to a request key <code class="docutils literal notranslate"><span class="pre">identifier</span></code> and <code class="docutils literal notranslate"><span class="pre">reqId</span></code>, the node will
then use this database to get the sequence number and then use the sequence number of get the transaction from the ledger.
This database is currently maintained only for domain ledger.</p>
<p>Relevant code:</p>
<ul class="simple">
<li>ReqIdrToTxn: <code class="docutils literal notranslate"><span class="pre">plenum/persistence/req_id_to_txn.py</span></code></li>
</ul>
</div>
<div class="section" id="common-storage-abstractions">
<span id="common-storage-abstractions"></span><h2>Common Storage abstractions<a class="headerlink" href="#common-storage-abstractions" title="Permalink to this headline">¶</a></h2>
<p>The data structures used in the code use some abstractions like a <code class="docutils literal notranslate"><span class="pre">KeyValueStorage</span></code> interface which has a LevelDB implementation
<code class="docutils literal notranslate"><span class="pre">KeyValueStorageLeveldb</span></code> and a planned RocksDB implementation, a <code class="docutils literal notranslate"><span class="pre">SingleFileStore</span></code> interface which has a <code class="docutils literal notranslate"><span class="pre">TextFileStore</span></code> and <code class="docutils literal notranslate"><span class="pre">BinaryFileStore</span></code>,
a <code class="docutils literal notranslate"><span class="pre">KeyValueStorageFile</span></code> interface with a <code class="docutils literal notranslate"><span class="pre">ChunkedFileStore</span></code> implementation and a <code class="docutils literal notranslate"><span class="pre">DirectoryStore</span></code></p>
<p>Relevant code:</p>
<ul class="simple">
<li>KeyValueStorage: <code class="docutils literal notranslate"><span class="pre">storage/kv_store.py</span></code></li>
<li>KeyValueStorageLeveldb: <code class="docutils literal notranslate"><span class="pre">storage/kv_store_leveldb.py</span></code></li>
<li>KeyValueStorageFile: <code class="docutils literal notranslate"><span class="pre">storage/kv_store_file.py</span></code></li>
<li>SingleFileStore: <code class="docutils literal notranslate"><span class="pre">storage/kv_store_single_file.py</span></code></li>
<li>BinaryFileStore: <code class="docutils literal notranslate"><span class="pre">storage/binary_file_store.py</span></code></li>
<li>TextFileStore: <code class="docutils literal notranslate"><span class="pre">storage/text_file_store.py</span></code></li>
<li>ChunkedFileStore: <code class="docutils literal notranslate"><span class="pre">storage/chunked_file_store.py</span></code></li>
<li>DirectoryStore: <code class="docutils literal notranslate"><span class="pre">storage/directory_store.py</span></code></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="request_handling.html" class="btn btn-neutral" title="Request handling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Hyperledger Indy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>